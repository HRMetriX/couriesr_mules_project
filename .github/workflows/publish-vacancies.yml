# .github/workflows/publish-vacancies.yml
name: Publish Vacancies to Telegram

on:
  schedule:
    # 13:00, 19:00, 21:00 –ø–æ –ú–æ—Å–∫–≤–µ (UTC+3 = GMT+3)
    - cron: '0 10,16,18 * * *'  # 10:00, 16:00, 18:00 UTC = 13:00, 19:00, 21:00 MSK
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  # –ó–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  workflow_run:
    workflows: ["Parse HH Jobs"]
    types:
      - completed

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
    # 1. –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (workflow_dispatch)
    # 2. –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (schedule)
    # 3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ (workflow_run —Å conclusion=success)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        pip install requests==2.31.0 supabase==1.1.1 python-dateutil==2.8.2
    
    - name: Debug - Check project structure
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞:"
        echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ scripts/:"
        ls -la scripts/
        echo ""
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ publisher_config.py:"
        if [ -f scripts/publisher_config.py ]; then
          echo "‚úÖ publisher_config.py –Ω–∞–π–¥–µ–Ω"
          echo "–ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫:"
          head -10 scripts/publisher_config.py
        else
          echo "‚ùå publisher_config.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: Run publisher
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—É–±–ª–∏–∫–∞—Ç–æ—Ä–∞..."
        echo "–¢–∏–ø —Ç—Ä–∏–≥–≥–µ—Ä–∞: ${{ github.event_name }}"
        python scripts/publisher_logic.py
    
    - name: Send notification on failure
      if: failure() && secrets.SLACK_WEBHOOK != ''
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_CHANNEL: alerts
        SLACK_COLOR: danger
        SLACK_TITLE: "‚ùå –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤–∞–∫–∞–Ω—Å–∏–π –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –æ—à–∏–±–∫–æ–π"
        SLACK_MESSAGE: "Workflow ${{ github.workflow }} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ GitHub Actions."
        SLACK_FOOTER: "Repository: ${{ github.repository }}"
