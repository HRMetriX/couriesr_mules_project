name: Monthly Report

on:
  schedule:
    - cron: '30 4 1 * *'  # 07:30 –ú–°–ö 1 —á–∏—Å–ª–∞
  workflow_dispatch:

jobs:
  run-report:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
        pip install -r requirements.txt
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    - name: Run monthly analytics
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."
        echo "üìÖ –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "üèôÔ∏è –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤"
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º
        cd scripts
        
        echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä–∏–ø—Ç–∞..."
        ls -la monthly_analytics.py || { echo "‚ùå –°–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"; exit 1; }
        
        echo "üìä –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É..."
        python -u monthly_analytics.py
        
        EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"
        else
          echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ (–∫–æ–¥: $EXIT_CODE)"
          exit $EXIT_CODE
        fi
    
    - name: Success log
      if: success()
      run: |
        echo "üéâ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "üìÖ –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
    
    - name: Failure log
      if: failure()
      run: |
        echo "üí• –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
        echo "üìÖ –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
